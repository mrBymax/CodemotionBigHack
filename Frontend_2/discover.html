<!DOCTYPE html>
<html lang="en">


<head>

    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>ST-udent Discover</title>

    <meta content="" name="description">

    <meta content="" name="keywords">

    <!-- FAVICONS -->

    <!-- CSS THIRD PART -->
    <link href="assets/bootstrap/bootstrap.min.css" rel="stylesheet">

    <!-- MAIN CSS -->
    <link href="assets/css/main.css" rel="stylesheet">

</head>

<body>
    <div class="container">

        <div class="py-5 text-center">
            <img class="d-block mx-auto mb-4" src="assets/img/logo.png" width="150" height="150">
            <h1 class="stColor">Discover</h1>
            <h4 class="titleDescription linea">Here you can analize your electronics component for discover and learn what components <a href="https://www.st.com/content/st_com/en.html" target="_blank" class="stColor">STMicroelectronics</a> produce for this object.</h4>
        </div>

        <div>
            <div>
                <div class="form-group">
                    <label for="uploadImage">Choose an image:</label>
                    <input type="file" 
                    class="form-control-file" 
                    id="uploadImage" accept="image/png, image/jpeg">
                </div>

                <button onclick="analyzeImage();" class="btn btn-primary mb-2 customButton">START THE ANALYSIS</button>
            </div>

            <!-- QUA VA LA RISPOSTA CHE ARRIVA DAL SERVER -->
            <div id="serverResponse">

            </div>
        </div>

        <!-- QUA VA IL CHATBOT -->
        <div>
            <h1 class="stColor">Assi<b>ST</b>ant</h1>
            
            <p>
                <a class="btn btn-primary" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                  Link with href
                </a>
                <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  Button with data-target
                </button>
              </p>
              

        </div>

    </div>

    <footer class="container text-center">
        <p>&copy; 2021 <a href="https://www.st.com/content/st_com/en.html" target="_blank" class="stColor">STMicroelectronics</a></p>
    </footer>

    <script src="assets/jquery-3.6.0.min.js"></script>
    <script src="assets/bootstrap/bootstrap.bundle.js"></script>


    <script>
        function loadComponentsInside(name){
            fetch(`http://localhost:8083/v1/classify/getInfo/${name}`, {
                            method: "GET",
                            mode: 'cors'
                        })
                        .then(response => response.json())
                        .then(data => {
                            let html = `<div id="accordion">`;
                            
                            for(let i in data){
                                let component = data[i];
                                html += `
                                <div class="card">
    <div class="card-header" id="heading${i}">
      <h5 class="mb-0">
        <button class="btn btn-link" data-toggle="collapse" 
        data-target="#component${i}" 
        aria-expanded="true" 
        aria-controls="collapseOne">
        ${component.name}
        </button>
      </h5>
    </div>

    <div id="component${i}" class="collapse" aria-labelledby="heading${i}" data-parent="#accordion">
      <div class="card-body">
        ${component.description}
        </div>
    </div>
  </div>
                                `
                            }
                            html += "</div>";

                            $("#componentList").html(html);
                        });
        }


        function showDataForDevice(item) {
            let name = item.class,
                imgUrl = item.imgEndpoint,
                score = item.score;

            let html =  `<h1>${name.toUpperCase()}</h1>` +
                        `<img src="${imgUrl}" alt="No block diagram available" />` +
                        `<h1>ST components inside:</h1>` +
                        `<div id="componentList">Loading...</div>`;
            
            $("#serverResponse").html(html);

            loadComponentsInside(name);
        }

        function analyzeImage() {
            function getBase64(file) {
                var reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function() {
                    fetch("http://localhost:8083/v1/classify/classifyImage", {
                            method: "POST",
                            mode: 'cors',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                image_b64: reader.result
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            let text = "Select:\n";
                            for (let i in data) {
                                let item = data[i],
                                    name = item.class,
                                    imgUrl = item.imgEndpoint,
                                    score = item.score;
                                text += `${i}: ${name} - ${score}\n`
                            }
                            let chosen = prompt(text, "0");
                            showDataForDevice(data[chosen]);
                        })
                };
                reader.onerror = function(error) {
                    console.log('Error: ', error);
                };
            }

            var file = document.getElementById('uploadImage').files[0];
            getBase64(file); // prints the base64 string
        }

    </script>





</body>

</html>
